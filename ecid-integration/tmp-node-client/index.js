/**
 * @adobe/target-nodejs-sdk v.1.0.0
 * Copyright 2019 Adobe. All rights reserved.
 * This file is licensed to you under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License. You may obtain a copy
 * of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under
 * the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
 * OF ANY KIND, either express or implied. See the License for the specific language
 * governing permissions and limitations under the License.
 */

"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var visitorJsServer=_interopDefault(require("@adobe-mcid/visitor-js-server")),request=_interopDefault(require("request"));const NOOP_LOGGER={debug(){},error(){}},AT_PREFIX="AT:",isObject=e=>e instanceof Object,isString=e=>"string"==typeof e||e instanceof String,isNumber=e=>"number"==typeof e||e instanceof Number,isPrimitiveObject=e=>e instanceof String||e instanceof Number||e instanceof Boolean||e instanceof Symbol,noUndefinedValues=e=>!!Object.values(e).filter(e=>void 0!==e).length,isNonEmptyObject=e=>isObject(e)&&!Array.isArray(e)&&!isPrimitiveObject(e)&&noUndefinedValues(e),isEmptyObject=e=>!isNonEmptyObject(e),isNonEmptyString=e=>isString(e)&&!!e.length,isEmptyString=e=>!isNonEmptyString(e),isNonEmptyArray=e=>Array.isArray(e)&&!!e.length&&noUndefinedValues(e),isEmptyArray=e=>!isNonEmptyArray(e),removeEmptyKeys=e=>Object.keys(e).forEach(t=>!e[t]&&delete e[t]),flatten=(e=[])=>[].concat(...e),getTimezoneOffset=()=>-(new Date).getTimezoneOffset();function getLogger(e){const{logger:t={}}=e,{debug:a,error:i}=t,r=Object.assign({},NOOP_LOGGER);return"function"==typeof a&&(r.debug=(...e)=>{t.debug.apply(null,[AT_PREFIX,...e])}),"function"==typeof i&&(r.error=(...e)=>{t.error.apply(null,[AT_PREFIX,...e])}),r}function normalizeCustomerIds(e){const t=Object.keys(e).reduce((t,a)=>{const i=e[a];return i?(t[a]=t[a]||{},null!=i.id?t[a].id=i.id:t[a].id=i,null!=i.authState?t[a].authState=i.authState:t[a].authState=visitorJsServer.AuthState.UNKNOWN,t):t},{});return isNonEmptyObject(t)?t:void 0}function createTargetOptions(e,t,a,i){const{targetCookie:r,targetLocationHintCookie:n,customerIds:s}=i,o={visitor:e,config:t,logger:a,targetCookie:r,targetLocationHintCookie:n};return s&&(o.customerIds=normalizeCustomerIds(s)),o}function createVisitor(e,t){const{organizationId:a}=t,{visitor:i,visitorCookie:r,customerIds:n}=e,s=i||new visitorJsServer(a,r);return n&&s.setCustomerIDs(n),s}var utils={isNonEmptyObject:isNonEmptyObject,isEmptyObject:isEmptyObject,isNonEmptyString:isNonEmptyString,isEmptyString:isEmptyString,isNonEmptyArray:isNonEmptyArray,isEmptyArray:isEmptyArray,isObject:isObject,isNumber:isNumber,removeEmptyKeys:removeEmptyKeys,flatten:flatten,getTimezoneOffset:getTimezoneOffset,getLogger:getLogger,createVisitor:createVisitor,createTargetOptions:createTargetOptions},messages={PRIVATE_CONSTRUCTOR:"Please use TargetClient.create static method instead",ORG_ID_REQUIRED:"Organization Id is required",REQUEST_REQUIRED:"Request object is required",EXECUTE_OR_PREFETCH_REQUIRED:"Either execute or prefetch is required in request",EXECUTE_FIELDS_REQUIRED:"Either pageLoad or mboxes is required in execute",PREFETCH_FIELDS_REQUIRED:"Either views, pageLoad or mboxes is required in prefetch",NOTIFICATIONS_REQUIRED:"Notifications array is required in request",MBOX_INVALID:"Mbox validation failed for: ",NOTIFICATION_INVALID:"Notification validation failed for: ",CLIENT_REQUIRED:"Client is required",OPTIONS_REQUIRED:"Options map is required",REQUEST_SENT:"Request sent",RESPONSE_RECEIVED:"Response received"};const{isNonEmptyObject:isNonEmptyObject$1,isEmptyObject:isEmptyObject$1,isEmptyArray:isEmptyArray$1,isEmptyString:isEmptyString$1}=utils;function validateClientOptions(e){if(isEmptyObject$1(e))return messages.OPTIONS_REQUIRED;const{client:t,organizationId:a}=e;return isEmptyString$1(t)?messages.CLIENT_REQUIRED:isEmptyString$1(a)?messages.ORG_ID_REQUIRED:null}function validateGetOffersOptions(e){if(isEmptyObject$1(e))return messages.OPTIONS_REQUIRED;const{request:t}=e;if(isEmptyObject$1(t))return messages.REQUEST_REQUIRED;const{execute:a,prefetch:i}=t;return isEmptyObject$1(a)&&isEmptyObject$1(i)?messages.EXECUTE_OR_PREFETCH_REQUIRED:isNonEmptyObject$1(a)&&isEmptyObject$1(a.pageLoad)&&isEmptyArray$1(a.mboxes)?messages.EXECUTE_FIELDS_REQUIRED:isNonEmptyObject$1(i)&&isEmptyObject$1(i.pageLoad)&&isEmptyArray$1(i.views)&&isEmptyArray$1(i.mboxes)?messages.PREFETCH_FIELDS_REQUIRED:null}function validateSendNotificationsOptions(e){if(isEmptyObject$1(e))return messages.OPTIONS_REQUIRED;const{request:t}=e;if(isEmptyObject$1(t))return messages.REQUEST_REQUIRED;const{notifications:a}=t;return isEmptyArray$1(a)?messages.NOTIFICATIONS_REQUIRED:null}var validators={validateClientOptions:validateClientOptions,validateGetOffersOptions:validateGetOffersOptions,validateSendNotificationsOptions:validateSendNotificationsOptions};const TARGET_COOKIE="mbox",SESSION_ID_COOKIE="session",DEVICE_ID_COOKIE="PC",LOCATION_HINT_COOKIE="mboxEdgeCluster";function createInternalCookie(e,t,a){return{name:e,value:t,expires:a}}function serializeCookie(e){return[encodeURIComponent(e.name),encodeURIComponent(e.value),e.expires].join("#")}function deserializeCookie(e){const t=e.split("#"),a=t.length;return 0===a||a<3?null:Number.isNaN(parseInt(t[2],10))?null:createInternalCookie(decodeURIComponent(t[0]),decodeURIComponent(t[1]),Number(t[2]))}function getInternalCookies(e){return e.split("|")}function getExpires(e){return e.expires}function getMaxExpires(e){return Math.max.apply(null,e.map(getExpires))}function parseCookies(e){const t={};if(!e)return t;const a=getInternalCookies(e).map(e=>deserializeCookie(e)),i=Math.ceil(Date.now()/1e3);return a.filter(e=>e&&i<=e.expires).forEach(e=>{t[e.name]=e}),t}function createTargetCookie(e){const t=Date.now(),a=Math.abs(1e3*getMaxExpires(e)-t),i=e.map(e=>serializeCookie(e));return{name:TARGET_COOKIE,value:i.join("|"),maxAge:Math.ceil(a/1e3)}}var cookies={parseCookies:parseCookies,createTargetCookie:createTargetCookie,TARGET_COOKIE:TARGET_COOKIE,SESSION_ID_COOKIE:"session",DEVICE_ID_COOKIE:"PC",LOCATION_HINT_COOKIE:"mboxEdgeCluster"};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function getCjsExportFromNamespace(e){return e&&e.default||e}var api=createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var a,i=(a=request)&&"object"==typeof a&&"default"in a?a.default:a;class r{static getAttributeTypeMap(){return r.attributeTypeMap}}r.discriminator=void 0,r.attributeTypeMap=[{name:"type",baseName:"type",type:"string"},{name:"selector",baseName:"selector",type:"string"},{name:"cssSelector",baseName:"cssSelector",type:"string"},{name:"content",baseName:"content",type:"OneOfstringobject"}];class n{static getAttributeTypeMap(){return n.attributeTypeMap}}n.discriminator=void 0,n.attributeTypeMap=[{name:"url",baseName:"url",type:"string"},{name:"referringUrl",baseName:"referringUrl",type:"string"}];class s{static getAttributeTypeMap(){return s.attributeTypeMap}}s.discriminator=void 0,s.attributeTypeMap=[{name:"pe",baseName:"pe",type:"string"},{name:"tnta",baseName:"tnta",type:"string"}];class o{static getAttributeTypeMap(){return o.attributeTypeMap}}o.discriminator=void 0,o.attributeTypeMap=[{name:"supplementalDataId",baseName:"supplementalDataId",type:"string"},{name:"logging",baseName:"logging",type:"LoggingType"},{name:"trackingServer",baseName:"trackingServer",type:"string"},{name:"trackingServerSecure",baseName:"trackingServerSecure",type:"string"}];class p{static getAttributeTypeMap(){return p.attributeTypeMap}}p.discriminator=void 0,p.attributeTypeMap=[{name:"payload",baseName:"payload",type:"AnalyticsPayload"}];class c{static getAttributeTypeMap(){return c.attributeTypeMap}}c.discriminator=void 0,c.attributeTypeMap=[{name:"id",baseName:"id",type:"string"},{name:"name",baseName:"name",type:"string"},{name:"version",baseName:"version",type:"string"}];class m{static getAttributeTypeMap(){return m.attributeTypeMap}}m.discriminator=void 0,m.attributeTypeMap=[{name:"locationHint",baseName:"locationHint",type:"number"},{name:"blob",baseName:"blob",type:"string"}],function(e){e[e.Unknown="unknown"]="Unknown",e[e.Authenticated="authenticated"]="Authenticated",e[e.LoggedOut="logged_out"]="LoggedOut"}(t.AuthenticatedState||(t.AuthenticatedState={}));class u{static getAttributeTypeMap(){return u.attributeTypeMap}}u.discriminator=void 0,u.attributeTypeMap=[{name:"host",baseName:"host",type:"string"},{name:"webGLRenderer",baseName:"webGLRenderer",type:"string"}],function(e){e[e.Mobile="mobile"]="Mobile",e[e.Web="web"]="Web"}(t.ChannelType||(t.ChannelType={}));class y{static getAttributeTypeMap(){return y.attributeTypeMap}}y.discriminator=void 0,y.attributeTypeMap=[{name:"channel",baseName:"channel",type:"ChannelType"},{name:"mobilePlatform",baseName:"mobilePlatform",type:"MobilePlatform"},{name:"application",baseName:"application",type:"Application"},{name:"screen",baseName:"screen",type:"Screen"},{name:"window",baseName:"window",type:"Window"},{name:"browser",baseName:"browser",type:"Browser"},{name:"address",baseName:"address",type:"Address"},{name:"geo",baseName:"geo",type:"Geo"},{name:"timeOffsetInMinutes",baseName:"timeOffsetInMinutes",type:"number"},{name:"userAgent",baseName:"userAgent",type:"string"},{name:"beacon",baseName:"beacon",type:"boolean"}];class d{static getAttributeTypeMap(){return d.attributeTypeMap}}d.discriminator=void 0,d.attributeTypeMap=[{name:"id",baseName:"id",type:"string"},{name:"integrationCode",baseName:"integrationCode",type:"string"},{name:"authenticatedState",baseName:"authenticatedState",type:"AuthenticatedState"}];class l{static getAttributeTypeMap(){return l.attributeTypeMap}}l.discriminator=void 0,l.attributeTypeMap=[{name:"requestId",baseName:"requestId",type:"string"},{name:"impressionId",baseName:"impressionId",type:"string"},{name:"id",baseName:"id",type:"VisitorId"},{name:"environmentId",baseName:"environmentId",type:"number"},{name:"property",baseName:"property",type:"Property"},{name:"trace",baseName:"trace",type:"Trace"},{name:"context",baseName:"context",type:"Context"},{name:"experienceCloud",baseName:"experienceCloud",type:"ExperienceCloud"},{name:"execute",baseName:"execute",type:"ExecuteRequest"},{name:"prefetch",baseName:"prefetch",type:"PrefetchRequest"},{name:"notifications",baseName:"notifications",type:"Array<Notification>"},{name:"qaMode",baseName:"qaMode",type:"QAMode"}];class b{static getAttributeTypeMap(){return b.attributeTypeMap}}b.discriminator=void 0,b.attributeTypeMap=[{name:"status",baseName:"status",type:"number"},{name:"requestId",baseName:"requestId",type:"string"},{name:"id",baseName:"id",type:"VisitorId"},{name:"client",baseName:"client",type:"string"},{name:"edgeHost",baseName:"edgeHost",type:"string"},{name:"execute",baseName:"execute",type:"ExecuteResponse"},{name:"prefetch",baseName:"prefetch",type:"PrefetchResponse"}],function(e){e[e.Phone="phone"]="Phone",e[e.Tablet="tablet"]="Tablet"}(t.DeviceType||(t.DeviceType={}));class g{static getAttributeTypeMap(){return g.attributeTypeMap}}g.discriminator=void 0,g.attributeTypeMap=[{name:"pageLoad",baseName:"pageLoad",type:"RequestDetails"},{name:"mboxes",baseName:"mboxes",type:"Array<MboxRequest>"}];class T{static getAttributeTypeMap(){return T.attributeTypeMap}}T.discriminator=void 0,T.attributeTypeMap=[{name:"pageLoad",baseName:"pageLoad",type:"PageLoadResponse"},{name:"mboxes",baseName:"mboxes",type:"Array<MboxResponse>"}];class N{static getAttributeTypeMap(){return N.attributeTypeMap}}N.discriminator=void 0,N.attributeTypeMap=[{name:"audienceManager",baseName:"audienceManager",type:"AudienceManager"},{name:"analytics",baseName:"analytics",type:"AnalyticsRequest"}];class E{static getAttributeTypeMap(){return E.attributeTypeMap}}E.discriminator=void 0,E.attributeTypeMap=[{name:"latitude",baseName:"latitude",type:"number"},{name:"longitude",baseName:"longitude",type:"number"}],function(e){e[e.ServerSide="server_side"]="ServerSide",e[e.ClientSide="client_side"]="ClientSide"}(t.LoggingType||(t.LoggingType={}));class f{static getAttributeTypeMap(){return f.attributeTypeMap}}f.discriminator=void 0,f.attributeTypeMap=[{name:"address",baseName:"address",type:"Address"},{name:"parameters",baseName:"parameters",type:"{ [key: string]: string; }"},{name:"profileParameters",baseName:"profileParameters",type:"{ [key: string]: string; }"},{name:"order",baseName:"order",type:"Order"},{name:"product",baseName:"product",type:"Product"},{name:"index",baseName:"index",type:"number"},{name:"name",baseName:"name",type:"string"}];class O{static getAttributeTypeMap(){return O.attributeTypeMap}}O.discriminator=void 0,O.attributeTypeMap=[{name:"index",baseName:"index",type:"number"},{name:"name",baseName:"name",type:"string"}];class A{static getAttributeTypeMap(){return A.attributeTypeMap}}A.discriminator=void 0,A.attributeTypeMap=[{name:"index",baseName:"index",type:"number"},{name:"name",baseName:"name",type:"string"},{name:"options",baseName:"options",type:"Array<Option>"},{name:"metrics",baseName:"metrics",type:"Array<Metric>"},{name:"analytics",baseName:"analytics",type:"AnalyticsResponse"},{name:"trace",baseName:"trace",type:"{ [key: string]: object; }"}];class I{static getAttributeTypeMap(){return I.attributeTypeMap}}I.discriminator=void 0,I.attributeTypeMap=[{name:"type",baseName:"type",type:"MetricType"},{name:"selector",baseName:"selector",type:"string"},{name:"eventToken",baseName:"eventToken",type:"string"}],function(e){e[e.Click="click"]="Click",e[e.Display="display"]="Display"}(t.MetricType||(t.MetricType={}));class v{static getAttributeTypeMap(){return v.attributeTypeMap}}v.discriminator=void 0,v.attributeTypeMap=[{name:"deviceName",baseName:"deviceName",type:"string"},{name:"deviceType",baseName:"deviceType",type:"DeviceType"},{name:"platformType",baseName:"platformType",type:"MobilePlatformType"},{name:"version",baseName:"version",type:"string"}],function(e){e[e.Android="android"]="Android",e[e.Ios="ios"]="Ios"}(t.MobilePlatformType||(t.MobilePlatformType={}));class M{static getAttributeTypeMap(){return M.attributeTypeMap}}M.discriminator=void 0,M.attributeTypeMap=[{name:"address",baseName:"address",type:"Address"},{name:"parameters",baseName:"parameters",type:"{ [key: string]: string; }"},{name:"profileParameters",baseName:"profileParameters",type:"{ [key: string]: string; }"},{name:"order",baseName:"order",type:"Order"},{name:"product",baseName:"product",type:"Product"},{name:"id",baseName:"id",type:"string"},{name:"impressionId",baseName:"impressionId",type:"string"},{name:"type",baseName:"type",type:"MetricType"},{name:"timestamp",baseName:"timestamp",type:"number"},{name:"tokens",baseName:"tokens",type:"Array<string>"},{name:"mbox",baseName:"mbox",type:"NotificationMbox"},{name:"view",baseName:"view",type:"NotificationView"},{name:"pageLoad",baseName:"pageLoad",type:"NotificationPageLoad"}];class x{static getAttributeTypeMap(){return x.attributeTypeMap}}x.discriminator=void 0,x.attributeTypeMap=[{name:"id",baseName:"id",type:"string"},{name:"impressionId",baseName:"impressionId",type:"string"},{name:"type",baseName:"type",type:"MetricType"},{name:"timestamp",baseName:"timestamp",type:"number"},{name:"tokens",baseName:"tokens",type:"Array<string>"},{name:"mbox",baseName:"mbox",type:"NotificationMbox"},{name:"view",baseName:"view",type:"NotificationView"},{name:"pageLoad",baseName:"pageLoad",type:"NotificationPageLoad"}];class C{static getAttributeTypeMap(){return C.attributeTypeMap}}C.discriminator=void 0,C.attributeTypeMap=[{name:"name",baseName:"name",type:"string"},{name:"state",baseName:"state",type:"string"}];class _{static getAttributeTypeMap(){return _.attributeTypeMap}}_.discriminator=void 0,_.attributeTypeMap=[{name:"state",baseName:"state",type:"string"}];class R{static getAttributeTypeMap(){return R.attributeTypeMap}}R.discriminator=void 0,R.attributeTypeMap=[{name:"name",baseName:"name",type:"string"},{name:"key",baseName:"key",type:"string"},{name:"state",baseName:"state",type:"string"}];class S{static getAttributeTypeMap(){return S.attributeTypeMap}}S.discriminator=void 0,S.attributeTypeMap=[{name:"type",baseName:"type",type:"OptionType"},{name:"content",baseName:"content",type:"OneOfstringobjectarray"},{name:"eventToken",baseName:"eventToken",type:"string"},{name:"responseTokens",baseName:"responseTokens",type:"{ [key: string]: object; }"}],function(e){e[e.Html="html"]="Html",e[e.Json="json"]="Json",e[e.Redirect="redirect"]="Redirect",e[e.Dynamic="dynamic"]="Dynamic",e[e.Actions="actions"]="Actions"}(t.OptionType||(t.OptionType={}));class h{static getAttributeTypeMap(){return h.attributeTypeMap}}h.discriminator=void 0,h.attributeTypeMap=[{name:"id",baseName:"id",type:"string"},{name:"total",baseName:"total",type:"number"},{name:"purchasedProductIds",baseName:"purchasedProductIds",type:"Array<string>"},{name:"time",baseName:"time",type:"Date"},{name:"experienceLocalId",baseName:"experienceLocalId",type:"number"},{name:"duplicate",baseName:"duplicate",type:"boolean"},{name:"outlier",baseName:"outlier",type:"boolean"}];class D{static getAttributeTypeMap(){return D.attributeTypeMap}}D.discriminator=void 0,D.attributeTypeMap=[{name:"options",baseName:"options",type:"Array<Option>"},{name:"metrics",baseName:"metrics",type:"Array<Metric>"},{name:"analytics",baseName:"analytics",type:"AnalyticsResponse"},{name:"state",baseName:"state",type:"string"},{name:"trace",baseName:"trace",type:"{ [key: string]: object; }"}];class ${static getAttributeTypeMap(){return $.attributeTypeMap}}$.discriminator=void 0,$.attributeTypeMap=[{name:"index",baseName:"index",type:"number"},{name:"name",baseName:"name",type:"string"},{name:"options",baseName:"options",type:"Array<Option>"},{name:"metrics",baseName:"metrics",type:"Array<Metric>"},{name:"analytics",baseName:"analytics",type:"AnalyticsResponse"},{name:"trace",baseName:"trace",type:"{ [key: string]: object; }"},{name:"state",baseName:"state",type:"string"}];class j{static getAttributeTypeMap(){return j.attributeTypeMap}}j.discriminator=void 0,j.attributeTypeMap=[{name:"state",baseName:"state",type:"string"}];class P{static getAttributeTypeMap(){return P.attributeTypeMap}}P.discriminator=void 0,P.attributeTypeMap=[{name:"views",baseName:"views",type:"Array<ViewRequest>"},{name:"pageLoad",baseName:"pageLoad",type:"RequestDetails"},{name:"mboxes",baseName:"mboxes",type:"Array<MboxRequest>"}];class k{static getAttributeTypeMap(){return k.attributeTypeMap}}k.discriminator=void 0,k.attributeTypeMap=[{name:"views",baseName:"views",type:"Array<View>"},{name:"pageLoad",baseName:"pageLoad",type:"PageLoadResponse"},{name:"mboxes",baseName:"mboxes",type:"Array<PrefetchMboxResponse>"},{name:"metrics",baseName:"metrics",type:"Array<Metric>"}];class w{static getAttributeTypeMap(){return w.attributeTypeMap}}w.discriminator=void 0,w.attributeTypeMap=[{name:"id",baseName:"id",type:"string"},{name:"categoryId",baseName:"categoryId",type:"string"}];class L{static getAttributeTypeMap(){return L.attributeTypeMap}}L.discriminator=void 0,L.attributeTypeMap=[{name:"token",baseName:"token",type:"string"}];class q{static getAttributeTypeMap(){return q.attributeTypeMap}}q.discriminator=void 0,q.attributeTypeMap=[{name:"token",baseName:"token",type:"string"},{name:"listedActivitiesOnly",baseName:"listedActivitiesOnly",type:"boolean"},{name:"evaluateAsTrueAudienceIds",baseName:"evaluateAsTrueAudienceIds",type:"Array<number>"},{name:"evaluateAsFalseAudienceIds",baseName:"evaluateAsFalseAudienceIds",type:"Array<number>"},{name:"previewIndexes",baseName:"previewIndexes",type:"Array<QAModePreviewIndex>"}];class V{static getAttributeTypeMap(){return V.attributeTypeMap}}V.discriminator=void 0,V.attributeTypeMap=[{name:"activityIndex",baseName:"activityIndex",type:"number"},{name:"experienceIndex",baseName:"experienceIndex",type:"number"}];class H{static getAttributeTypeMap(){return H.attributeTypeMap}}H.discriminator=void 0,H.attributeTypeMap=[{name:"address",baseName:"address",type:"Address"},{name:"parameters",baseName:"parameters",type:"{ [key: string]: string; }"},{name:"profileParameters",baseName:"profileParameters",type:"{ [key: string]: string; }"},{name:"order",baseName:"order",type:"Order"},{name:"product",baseName:"product",type:"Product"}];class U{static getAttributeTypeMap(){return U.attributeTypeMap}}U.discriminator=void 0,U.attributeTypeMap=[{name:"width",baseName:"width",type:"number"},{name:"height",baseName:"height",type:"number"},{name:"colorDepth",baseName:"colorDepth",type:"number"},{name:"pixelRatio",baseName:"pixelRatio",type:"number"},{name:"orientation",baseName:"orientation",type:"ScreenOrientationType"}],function(e){e[e.Portrait="portrait"]="Portrait",e[e.Landscape="landscape"]="Landscape"}(t.ScreenOrientationType||(t.ScreenOrientationType={}));class F{static getAttributeTypeMap(){return F.attributeTypeMap}}F.discriminator=void 0,F.attributeTypeMap=[{name:"authorizationToken",baseName:"authorizationToken",type:"string"},{name:"usage",baseName:"usage",type:"{ [key: string]: string; }"}];class Q{static getAttributeTypeMap(){return Q.attributeTypeMap}}Q.discriminator=void 0,Q.attributeTypeMap=[{name:"status",baseName:"status",type:"number"},{name:"message",baseName:"message",type:"string"}];class K{static getAttributeTypeMap(){return K.attributeTypeMap}}K.discriminator=void 0,K.attributeTypeMap=[{name:"name",baseName:"name",type:"string"},{name:"key",baseName:"key",type:"string"},{name:"options",baseName:"options",type:"Array<Option>"},{name:"metrics",baseName:"metrics",type:"Array<Metric>"},{name:"analytics",baseName:"analytics",type:"AnalyticsResponse"},{name:"state",baseName:"state",type:"string"},{name:"trace",baseName:"trace",type:"{ [key: string]: object; }"}];class z{static getAttributeTypeMap(){return z.attributeTypeMap}}z.discriminator=void 0,z.attributeTypeMap=[{name:"address",baseName:"address",type:"Address"},{name:"parameters",baseName:"parameters",type:"{ [key: string]: string; }"},{name:"profileParameters",baseName:"profileParameters",type:"{ [key: string]: string; }"},{name:"order",baseName:"order",type:"Order"},{name:"product",baseName:"product",type:"Product"},{name:"name",baseName:"name",type:"string"},{name:"key",baseName:"key",type:"string"}];class G{static getAttributeTypeMap(){return G.attributeTypeMap}}G.discriminator=void 0,G.attributeTypeMap=[{name:"name",baseName:"name",type:"string"},{name:"key",baseName:"key",type:"string"}];class X{static getAttributeTypeMap(){return X.attributeTypeMap}}X.discriminator=void 0,X.attributeTypeMap=[{name:"tntId",baseName:"tntId",type:"string"},{name:"thirdPartyId",baseName:"thirdPartyId",type:"string"},{name:"marketingCloudVisitorId",baseName:"marketingCloudVisitorId",type:"string"},{name:"customerIds",baseName:"customerIds",type:"Array<CustomerId>"}];class B{static getAttributeTypeMap(){return B.attributeTypeMap}}B.discriminator=void 0,B.attributeTypeMap=[{name:"width",baseName:"width",type:"number"},{name:"height",baseName:"height",type:"number"}];let J=["string","boolean","double","integer","long","float","number","any"],W={AuthenticatedState:t.AuthenticatedState,ChannelType:t.ChannelType,DeviceType:t.DeviceType,LoggingType:t.LoggingType,MetricType:t.MetricType,MobilePlatformType:t.MobilePlatformType,OptionType:t.OptionType,ScreenOrientationType:t.ScreenOrientationType},Y={Action:r,Address:n,AnalyticsPayload:s,AnalyticsRequest:o,AnalyticsResponse:p,Application:c,AudienceManager:m,Browser:u,Context:y,CustomerId:d,DeliveryRequest:l,DeliveryResponse:b,ExecuteRequest:g,ExecuteResponse:T,ExperienceCloud:N,Geo:E,MboxRequest:f,MboxRequestAllOf:O,MboxResponse:A,Metric:I,MobilePlatform:v,Notification:M,NotificationAllOf:x,NotificationMbox:C,NotificationPageLoad:_,NotificationView:R,Option:S,Order:h,PageLoadResponse:D,PrefetchMboxResponse:$,PrefetchMboxResponseAllOf:j,PrefetchRequest:P,PrefetchResponse:k,Product:w,Property:L,QAMode:q,QAModePreviewIndex:V,RequestDetails:H,Screen:U,Trace:F,UnexpectedError:Q,View:K,ViewRequest:z,ViewRequestAllOf:G,VisitorId:X,Window:B};class Z{static findCorrectType(e,t){if(null==e)return t;if(-1!==J.indexOf(t.toLowerCase()))return t;if("Date"===t)return t;{if(W[t])return t;if(!Y[t])return t;let i=Y[t].discriminator;if(null==i)return t;if(e[i]){var a=e[i];return Y[a]?a:t}return t}}static serialize(e,t){if(null==e)return e;if(-1!==J.indexOf(t.toLowerCase()))return e;if(0===t.lastIndexOf("Array<",0)){let a=t.replace("Array<","");a=a.substring(0,a.length-1);let i=[];for(let t in e){let r=e[t];i.push(Z.serialize(r,a))}return i}if("Date"===t)return e.toISOString();{if(W[t])return e;if(!Y[t])return e;t=this.findCorrectType(e,t);let a=Y[t].getAttributeTypeMap(),i={};for(let t in a){let r=a[t];i[r.baseName]=Z.serialize(e[r.name],r.type)}return i}}static deserialize(e,t){if(t=Z.findCorrectType(e,t),null==e)return e;if(-1!==J.indexOf(t.toLowerCase()))return e;if(0===t.lastIndexOf("Array<",0)){let a=t.replace("Array<","");a=a.substring(0,a.length-1);let i=[];for(let t in e){let r=e[t];i.push(Z.deserialize(r,a))}return i}if("Date"===t)return new Date(e);{if(W[t])return e;if(!Y[t])return e;let a=new Y[t],i=Y[t].getAttributeTypeMap();for(let t in i){let r=i[t];a[r.name]=Z.deserialize(e[r.baseName],r.type)}return a}}}let ee="https://.tt.omtrdc.net",te=1e4;class ae{constructor(e){this._basePath=ee,this._timeout=te,this.defaultHeaders={},this._useQuerystring=!1,e&&(this.basePath=e)}set useQuerystring(e){this._useQuerystring=e}set basePath(e){this._basePath=e}get basePath(){return this._basePath}set timeout(e){this._timeout=e}get timeout(){return this._timeout}execute(e,t,a,r={headers:{}}){return function(e,t,a,i){return new(a||(a=Promise))(function(r,n){function s(e){try{p(i.next(e))}catch(e){n(e)}}function o(e){try{p(i.throw(e))}catch(e){n(e)}}function p(e){e.done?r(e.value):new a(function(t){t(e.value)}).then(s,o)}p((i=i.apply(e,t||[])).next())})}(this,void 0,void 0,function*(){const n=this.basePath+"/rest/v1/delivery";let s={},o=Object.assign({},this.defaultHeaders),p={};if(null==e)throw new Error("Required parameter client was null or undefined when calling execute.");if(null==t)throw new Error("Required parameter sessionId was null or undefined when calling execute.");if(null==a)throw new Error("Required parameter deliveryRequest was null or undefined when calling execute.");void 0!==e&&(s.client=Z.serialize(e,"string")),void 0!==t&&(s.sessionId=Z.serialize(t,"string")),Object.assign(o,r.headers);let c={method:"POST",qs:s,headers:o,uri:n,useQuerystring:this._useQuerystring,timeout:this._timeout||te,time:!0,json:!0,body:Z.serialize(a,"DeliveryRequest")};return Object.keys(p).length&&(c.form=p),new Promise((e,t)=>{i(c,(a,i,r)=>{if(a)t(a);else{r=Z.deserialize(r,"DeliveryResponse");const{statusCode:a,timingPhases:n}=i;a&&a>=200&&a<=299?e({statusCode:a,timing:n,body:r}):t({statusCode:a,timing:n,body:r})}})})})}}const ie=[ae];t.APIS=ie,t.Action=r,t.Address=n,t.AnalyticsPayload=s,t.AnalyticsRequest=o,t.AnalyticsResponse=p,t.Application=c,t.AudienceManager=m,t.Browser=u,t.Context=y,t.CustomerId=d,t.DeliveryRequest=l,t.DeliveryResponse=b,t.ExecuteRequest=g,t.ExecuteResponse=T,t.ExperienceCloud=N,t.Geo=E,t.MboxRequest=f,t.MboxRequestAllOf=O,t.MboxResponse=A,t.Metric=I,t.MobilePlatform=v,t.Notification=M,t.NotificationAllOf=x,t.NotificationMbox=C,t.NotificationPageLoad=_,t.NotificationView=R,t.ObjectSerializer=Z,t.Option=S,t.Order=h,t.PageLoadResponse=D,t.PrefetchMboxResponse=$,t.PrefetchMboxResponseAllOf=j,t.PrefetchRequest=P,t.PrefetchResponse=k,t.Product=w,t.Property=L,t.QAMode=q,t.QAModePreviewIndex=V,t.RequestDetails=H,t.Screen=U,t.TargetDeliveryApi=ae,t.Trace=F,t.UnexpectedError=Q,t.View=K,t.ViewRequest=z,t.ViewRequestAllOf=G,t.VisitorId=X,t.Window=B});unwrapExports(api);var api_1=api.AuthenticatedState,api_2=api.ChannelType,api_3=api.DeviceType,api_4=api.LoggingType,api_5=api.MetricType,api_6=api.MobilePlatformType,api_7=api.OptionType,api_8=api.ScreenOrientationType,api_9=api.APIS,api_10=api.Action,api_11=api.Address,api_12=api.AnalyticsPayload,api_13=api.AnalyticsRequest,api_14=api.AnalyticsResponse,api_15=api.Application,api_16=api.AudienceManager,api_17=api.Browser,api_18=api.Context,api_19=api.CustomerId,api_20=api.DeliveryRequest,api_21=api.DeliveryResponse,api_22=api.ExecuteRequest,api_23=api.ExecuteResponse,api_24=api.ExperienceCloud,api_25=api.Geo,api_26=api.MboxRequest,api_27=api.MboxRequestAllOf,api_28=api.MboxResponse,api_29=api.Metric,api_30=api.MobilePlatform,api_31=api.Notification,api_32=api.NotificationAllOf,api_33=api.NotificationMbox,api_34=api.NotificationPageLoad,api_35=api.NotificationView,api_36=api.ObjectSerializer,api_37=api.Option,api_38=api.Order,api_39=api.PageLoadResponse,api_40=api.PrefetchMboxResponse,api_41=api.PrefetchMboxResponseAllOf,api_42=api.PrefetchRequest,api_43=api.PrefetchResponse,api_44=api.Product,api_45=api.Property,api_46=api.QAMode,api_47=api.QAModePreviewIndex,api_48=api.RequestDetails,api_49=api.Screen,api_50=api.TargetDeliveryApi,api_51=api.Trace,api_52=api.UnexpectedError,api_53=api.View,api_54=api.ViewRequest,api_55=api.ViewRequestAllOf,api_56=api.VisitorId,api_57=api.Window;function random(e,t){return e+Math.floor(Math.random()*(t-e+1))}function uuid(){let e=Date.now();return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,t=>{const a=(e+random(0,16))%16|0;return e=Math.floor(e/16),("x"===t?a:3&a|8).toString(16)})}var uuid_1=uuid,name="@adobe/target-nodejs-sdk",version="1.0.0",description="Adobe Target Node.js SDK, Delivery API client",main="lib/index.js",engines={node:">=8.16.0"},scripts={clean:"rimraf lib",prebuild:"npm run clean && npm run format && npm run lint",build:"rollup -c rollup.config.js",www:"npm run build && node ./sample/server.js",pretest:"npm run lint-test",test:"jasmine test/*.spec.js",coverage:"nyc --reporter=lcov --reporter=text-summary npm run test",testdebug:"node --inspect-brk node_modules/jasmine/bin/jasmine.js test/*.spec.js","lint-src":"eslint src/**","lint-test":"eslint test/**",lint:"npm run lint-src && npm run lint-test",format:"prettier --write {src,test}/**/*.js"},repository={type:"git",url:"git@github.com:adobe/target-nodejs-sdk.git"},keywords=["NodeJS","Server","API","Adobe","Target","MCID","Visitor","Delivery"],author="Adobe Systems Inc.",license="Apache-2.0",devDependencies={"cookie-parser":"^1.4.4",eslint:"^5.3.0","eslint-config-airbnb-base":"^13.2.0","eslint-config-prettier":"^6.0.0","eslint-plugin-import":"^2.18.2","eslint-plugin-jasmine":"^2.10.1","eslint-plugin-prettier":"^3.1.0",express:"^4.17.1",jasmine:"^3.4.0","jasmine-console-reporter":"^3.1.0",nyc:"^14.1.1",prettier:"^1.18.2",rewire:"^4.0.1",rimraf:"^2.6.1",rollup:"^1.17.0","rollup-plugin-commonjs":"^10.0.1","rollup-plugin-json":"^4.0.0","rollup-plugin-license":"^0.12.1","rollup-plugin-node-resolve":"^5.2.0","rollup-plugin-terser":"^5.1.1",sinon:"^7.4.1"},dependencies={"@adobe-mcid/visitor-js-server":"^2.0.0",request:"^2.81.0"},_package={name:name,version:version,description:description,main:main,engines:engines,scripts:scripts,"pre-commit":["precommit-msg","format","lint","test"],repository:repository,keywords:keywords,author:author,license:license,devDependencies:devDependencies,dependencies:dependencies},_package$1=Object.freeze({name:name,version:version,description:description,main:main,engines:engines,scripts:scripts,repository:repository,keywords:keywords,author:author,license:license,devDependencies:devDependencies,dependencies:dependencies,default:_package}),require$$2=getCjsExportFromNamespace(_package$1);const{MBOX_INVALID:MBOX_INVALID,NOTIFICATION_INVALID:NOTIFICATION_INVALID}=messages,{AuthenticatedState:AuthenticatedState,CustomerId:CustomerId,VisitorId:VisitorId,Trace:Trace,ChannelType:ChannelType,Context:Context,LoggingType:LoggingType,AnalyticsRequest:AnalyticsRequest,AudienceManager:AudienceManager,ExperienceCloud:ExperienceCloud,ExecuteRequest:ExecuteRequest,PrefetchRequest:PrefetchRequest,MetricType:MetricType,ObjectSerializer:ObjectSerializer,DeliveryRequest:DeliveryRequest,TargetDeliveryApi:TargetDeliveryApi}=api,{createTargetCookie:createTargetCookie$1,DEVICE_ID_COOKIE:DEVICE_ID_COOKIE$1,LOCATION_HINT_COOKIE:LOCATION_HINT_COOKIE$1,SESSION_ID_COOKIE:SESSION_ID_COOKIE$1}=cookies,{version:version$1}=require$$2,{isObject:isObject$1,isNumber:isNumber$1,isNonEmptyObject:isNonEmptyObject$2,isEmptyObject:isEmptyObject$2,isNonEmptyString:isNonEmptyString$1,isEmptyString:isEmptyString$2,isNonEmptyArray:isNonEmptyArray$1,isEmptyArray:isEmptyArray$2,removeEmptyKeys:removeEmptyKeys$1,flatten:flatten$1,getTimezoneOffset:getTimezoneOffset$1}=utils,SCHEME={HTTP:"http://",HTTPS:"https://"},AUTH_STATE={0:AuthenticatedState.Unknown,1:AuthenticatedState.Authenticated,2:AuthenticatedState.LoggedOut},DEFAULT_GLOBAL_MBOX="target-global-mbox",EDGE_CLUSTER_PREFIX="mboxedge",HOST="tt.omtrdc.net",SESSION_ID_MAX_AGE=1860,DEVICE_ID_MAX_AGE=63244800,LOCATION_HINT_MAX_AGE=1860;function extractClusterFromDeviceId(e){if(isEmptyString$2(e))return null;const t=e.split(".");if(2!==t.length||!t[1])return null;const a=t[1].split("_");return 2===a.length&&a[0]?a[0]:null}function getCluster(e,t){return extractClusterFromDeviceId(e)||t}function getDeviceId(e){const t=e[DEVICE_ID_COOKIE$1]||{},{value:a}=t;if(!isEmptyString$2(a))return a}function getSessionId(e,t){const a=e[SESSION_ID_COOKIE$1]||{},{value:i}=a;return isNonEmptyString$1(i)?i:t||uuid_1()}function getTargetHost(e,t,a,i){const r=!1===i?SCHEME.HTTP:SCHEME.HTTPS;return isNonEmptyString$1(e)?`${r}${e}`:isNonEmptyString$1(t)?`${r}${EDGE_CLUSTER_PREFIX}${t}.${HOST}`:`${r}${a}.${HOST}`}function createHeaders(){return{"Content-Type":"application/json","X-EXC-SDK":"AdobeTargetNode","X-EXC-SDK-Version":version$1,"X-Request-Id":uuid_1()}}function getMarketingCloudVisitorId(e){const t=e.getVisitorValues(),{MCMID:a}=t;return a}function getVisitorCustomerIds(e){const t=e.getState();return t[Object.keys(t)[0]].customerIDs}function getCustomerIds(e,t){const a=getVisitorCustomerIds(t);if(isEmptyObject$2(a))return e;const i=Object.keys(a).reduce((e,t)=>{const i=new CustomerId,r=a[t];return r?(isObject$1(r)?(i.id=r.id||void 0,i.integrationCode=t||void 0,i.authenticatedState=AUTH_STATE[r.authState]||void 0):(i.id=r,i.integrationCode=t||void 0,i.authenticatedState=AUTH_STATE[0]),e.push(i),e):e},[]);return i.length?i.concat(e||[]):e}function createVisitorId(e={},t){const{deviceId:a,visitor:i}=t,{tntId:r=a,thirdPartyId:n,marketingCloudVisitorId:s=getMarketingCloudVisitorId(i),customerIds:o}=e,p=getCustomerIds(o,i),c=new VisitorId;return isNonEmptyString$1(r)&&(c.tntId=r),isNonEmptyString$1(n)&&(c.thirdPartyId=n),isNonEmptyString$1(s)&&(c.marketingCloudVisitorId=s),isNonEmptyArray$1(p)&&(c.customerIds=p),isNonEmptyObject$2(c)?c:void 0}function createTrace(e=new Trace){const{authorizationToken:t}=e;if(isNonEmptyString$1(t))return e}function createContext(e={}){const{channel:t,timeOffsetInMinutes:a=getTimezoneOffset$1()}=e;if(Object.keys(ChannelType).includes(t))return e;const i=new Context;return i.channel=ChannelType.Web,i.timeOffsetInMinutes=a,i}function createSupplementalDataId(e){const{visitor:t,consumerId:a=DEFAULT_GLOBAL_MBOX}=e;return t.getSupplementalDataID(a)}function createAnalytics(e={},t){const{supplementalDataId:a=createSupplementalDataId(t),logging:i=LoggingType.ServerSide,trackingServer:r,trackingServerSecure:n}=e,s=new AnalyticsRequest;return s.logging=i,s.supplementalDataId=a,isNonEmptyString$1(r)&&(s.trackingServer=r),isNonEmptyString$1(n)&&(s.trackingServerSecure=n),s}function getLocationHint(e){const t=parseInt(e,10);return isNaN(t)?void 0:t}function createAudienceManager(e={},t){const{visitor:a}=t,i=a.getVisitorValues()||{},{locationHint:r=getLocationHint(i.MCAAMLH),blob:n=i.MCAAMB}=e,s=new AudienceManager;return r&&(s.locationHint=r),n&&(s.blob=n),isNonEmptyObject$2(s)?s:void 0}function createExperienceCloud(e={},t){const{analytics:a,audienceManager:i}=e,r=new ExperienceCloud;r.analytics=createAnalytics(a,t);const n=createAudienceManager(i,t);return n&&(r.audienceManager=n),r}function createParams(e,t={}){const a=new api[e],i=Object.assign({},t.parameters);isNonEmptyObject$2(i)&&(a.parameters=i);const r=Object.assign({},t.profileParameters);isNonEmptyObject$2(r)&&(a.profileParameters=r);const n=Object.assign({},t.order);isNonEmptyObject$2(n)&&(a.order=n);const s=Object.assign({},t.product);return isNonEmptyObject$2(s)&&(a.product=s),isNonEmptyObject$2(t.address)&&(a.address=t.address),a}const validMbox=(e,t)=>{const a=isNonEmptyObject$2(e)&&isNonEmptyString$1(e.name);return a||t.error(MBOX_INVALID,e),a};function createMboxes(e,t){if(isEmptyArray$2(e))return;const a=e.filter(e=>validMbox(e,t)).map((e,t)=>{const a=createParams("MboxRequest",e);return a.name=e.name,isNumber$1(e.index)?a.index=e.index:a.index=t,a});return isNonEmptyArray$1(a)?a:void 0}function createViews(e){if(isEmptyArray$2(e))return;const t=e.map(e=>{const t=createParams("ViewRequest",e);return isNonEmptyString$1(e.name)&&(t.name=e.name),isNonEmptyString$1(e.key)&&(t.key=e.key),t});return isNonEmptyArray$1(t)?t:void 0}function createExecute(e,t){if(isEmptyObject$2(e))return;const{pageLoad:a,mboxes:i}=e;if(isEmptyObject$2(a)&&isEmptyArray$2(i))return;const r=new ExecuteRequest;return isNonEmptyObject$2(a)&&(r.pageLoad=createParams("RequestDetails",a)),isNonEmptyArray$1(i)&&(r.mboxes=createMboxes(i,t)),r}function createPrefetch(e,t){if(isEmptyObject$2(e))return;const{pageLoad:a,views:i,mboxes:r}=e;if(isEmptyObject$2(a)&&isEmptyArray$2(i)&&isEmptyArray$2(r))return;const n=new PrefetchRequest;return isNonEmptyObject$2(a)&&(n.pageLoad=createParams("RequestDetails",a)),isNonEmptyArray$1(i)&&(n.views=createViews(i)),isNonEmptyArray$1(r)&&(n.mboxes=createMboxes(r,t)),n}const validNotification=(e,t)=>{const a=isNonEmptyObject$2(e)&&isNonEmptyString$1(e.id)&&isNumber$1(e.timestamp)&&Object.keys(MetricType).includes(e.type);return a||t.error(NOTIFICATION_INVALID,e),a};function createNotifications(e,t){if(isEmptyArray$2(e))return;const a=e.filter(e=>validNotification(e,t)).map(e=>{const{id:t,type:a,timestamp:i,impressionId:r,tokens:n,mbox:s,view:o}=e,p=createParams("Notification",e);return p.id=t,p.type=a,p.timestamp=i,isNonEmptyString$1(r)&&(p.impressionId=r),isNonEmptyArray$1(n)&&(p.tokens=n),isNonEmptyObject$2(s)&&(p.mbox=s),isNonEmptyObject$2(o)&&(p.view=o),p});return isNonEmptyArray$1(a)?a:void 0}function createProperty(e={}){const{token:t}=e;if(isNonEmptyString$1(t))return e}function createDeliveryRequest(e,t){const a=ObjectSerializer.deserialize(e,"DeliveryRequest"),{requestId:i=uuid_1(),impressionId:r,id:n,environmentId:s,property:o,trace:p,context:c,experienceCloud:m,execute:u,prefetch:y,notifications:d,qaMode:l}=a,{logger:b}=t,g=new DeliveryRequest;return g.requestId=i,g.impressionId=r,g.id=createVisitorId(n,t),g.environmentId=s,g.property=createProperty(o),g.trace=createTrace(p),g.context=createContext(c),g.experienceCloud=createExperienceCloud(m,t),g.execute=createExecute(u,b),g.prefetch=createPrefetch(y,b),g.notifications=createNotifications(d,b),g.qaMode=l,removeEmptyKeys$1(g),g}function createDeliveryApi(e,t){const a=new TargetDeliveryApi(e);return a.timeout=t,a}function getTargetCookie(e,t){const a=Math.ceil(Date.now()/1e3),i=[],{tntId:r}=t;return i.push({name:SESSION_ID_COOKIE$1,value:e,expires:a+SESSION_ID_MAX_AGE}),r&&i.push({name:DEVICE_ID_COOKIE$1,value:r,expires:a+DEVICE_ID_MAX_AGE}),createTargetCookie$1(i)}function extractClusterFromEdgeHost(e){if(isEmptyString$2(e))return null;const t=e.split(".");return 4===t.length&&t[0]?t[0].replace(EDGE_CLUSTER_PREFIX,""):null}function getTargetLocationHintCookie(e,t){const a=extractClusterFromEdgeHost(t),i=e||a;if(!isEmptyString$2(i))return{name:LOCATION_HINT_COOKIE$1,value:i,maxAge:LOCATION_HINT_MAX_AGE}}function getAnalyticsFromObject(e={}){const{analytics:t}=e;return isNonEmptyObject$2(t)?[t]:void 0}function getAnalyticsFromArray(e=[]){return flatten$1(e.map(getAnalyticsFromObject))}function getAnalyticsDetails(e){const{execute:t={},prefetch:a={}}=e;if(isEmptyObject$2(t)&&isEmptyObject$2(a))return;const i=getAnalyticsFromObject(t.pageLoad),r=getAnalyticsFromArray(t.mboxes),n=getAnalyticsFromObject(a.pageLoad),s=getAnalyticsFromArray(a.views),o=getAnalyticsFromArray(a.mboxes),p=flatten$1([i,r,n,s,o].filter(e=>!!e));return isNonEmptyArray$1(p)?p:void 0}function getTraceFromObject(e={}){const{trace:t}=e;return isNonEmptyObject$2(t)?[t]:void 0}function getTraceFromArray(e=[]){return flatten$1(e.map(getTraceFromObject))}function getTraceDetails(e){const{execute:t={},prefetch:a={}}=e;if(isEmptyObject$2(t)&&isEmptyObject$2(a))return;const i=getTraceFromObject(t.pageLoad),r=getTraceFromArray(t.mboxes),n=getTraceFromObject(a.pageLoad),s=getTraceFromArray(a.views),o=getTraceFromArray(a.mboxes),p=flatten$1([i,r,n,s,o].filter(e=>!!e));return isNonEmptyArray$1(p)?p:void 0}function getResponseTokensFromObject(e={}){const{options:t}=e;return isEmptyArray$2(t)?[]:t.map(e=>e.responseTokens).filter(isNonEmptyObject$2)}function getResponseTokensFromArray(e=[]){return flatten$1(e.map(getResponseTokensFromObject))}function getResponseTokens(e){const{execute:t={},prefetch:a={}}=e;if(isEmptyObject$2(t)&&isEmptyObject$2(a))return;const i=getResponseTokensFromObject(t.pageLoad),r=getResponseTokensFromArray(t.mboxes),n=getResponseTokensFromObject(a.pageLoad),s=getResponseTokensFromArray(a.views),o=getResponseTokensFromArray(a.mboxes),p=flatten$1([i,r,n,s,o]);return isNonEmptyArray$1(p)?p:void 0}function processResponse(e,t,a={}){const{timing:i,body:r={}}=a,{id:n={},edgeHost:s}=r,o={targetCookie:getTargetCookie(e,n),targetLocationHintCookie:getTargetLocationHintCookie(t,s),analyticsDetails:getAnalyticsDetails(r),trace:getTraceDetails(r),responseTokens:getResponseTokens(r),response:r,timing:i};return removeEmptyKeys$1(o),o}var helper={getDeviceId:getDeviceId,getCluster:getCluster,getSessionId:getSessionId,getTargetHost:getTargetHost,createHeaders:createHeaders,createDeliveryRequest:createDeliveryRequest,createDeliveryApi:createDeliveryApi,processResponse:processResponse,createVisitorId:createVisitorId};const{parseCookies:parseCookies$1}=cookies,{getDeviceId:getDeviceId$1,getCluster:getCluster$1,getSessionId:getSessionId$1,getTargetHost:getTargetHost$1,createHeaders:createHeaders$1,createDeliveryRequest:createDeliveryRequest$1,createDeliveryApi:createDeliveryApi$1,processResponse:processResponse$1}=helper,{REQUEST_SENT:REQUEST_SENT,RESPONSE_RECEIVED:RESPONSE_RECEIVED}=messages;function executeDelivery(e){const{visitor:t,config:a,logger:i,targetLocationHintCookie:r,targetCookie:n,consumerId:s,request:o}=e,{serverDomain:p,client:c,timeout:m,secure:u}=a,y=parseCookies$1(n),d=getDeviceId$1(y),l=getCluster$1(d,r),b=getTargetHost$1(p,l,c,u),g=getSessionId$1(y,e.sessionId),T=createHeaders$1(),N=createDeliveryRequest$1(o,{logger:i,visitor:t,deviceId:d,consumerId:s});return i.debug(REQUEST_SENT,JSON.stringify(N,null,2)),createDeliveryApi$1(b,m).execute(c,g,N,{headers:T}).then((e={})=>(i.debug(RESPONSE_RECEIVED,JSON.stringify(e.body,null,2)),Object.assign({visitorState:t.getState(),request:N},processResponse$1(g,l,e))))}var target={executeDelivery:executeDelivery};const{getLogger:getLogger$1,createVisitor:createVisitor$1}=utils,{validateClientOptions:validateClientOptions$1,validateGetOffersOptions:validateGetOffersOptions$1,validateSendNotificationsOptions:validateSendNotificationsOptions$1}=validators,{executeDelivery:executeDelivery$1}=target,{TARGET_COOKIE:TARGET_COOKIE$1,LOCATION_HINT_COOKIE:LOCATION_HINT_COOKIE$2}=cookies,AMCV_PREFIX="AMCV_",DEFAULT_TIMEOUT=3e3;class TargetClient{constructor(e){if(!e||!e.internal)throw new Error(messages.PRIVATE_CONSTRUCTOR);this.config=e,this.config.timeout=e.timeout||DEFAULT_TIMEOUT,this.logger=getLogger$1(e)}static create(e){const t=validateClientOptions$1(e);if(t)throw new Error(t);return new TargetClient(Object.assign({internal:!0},e))}getOffers(e){const t=validateGetOffersOptions$1(e);if(t)return Promise.reject(new Error(t));const a=createVisitor$1(e,this.config),i=Object.assign({visitor:a,config:this.config,logger:this.logger},e);return executeDelivery$1(i)}sendNotifications(e){const t=validateSendNotificationsOptions$1(e);if(t)return Promise.reject(new Error(t));const a=createVisitor$1(e,this.config),i=Object.assign({visitor:a,config:this.config,logger:this.logger},e);return executeDelivery$1(i)}static getVisitorCookieName(e){return AMCV_PREFIX+e}static get TargetCookieName(){return TARGET_COOKIE$1}static get TargetLocationHintCookieName(){return LOCATION_HINT_COOKIE$2}static get AuthState(){return visitorJsServer.AuthState}}var src=TargetClient;module.exports=src;
//# sourceMappingURL=index.js.map
